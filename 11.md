# VLESS Cloudflare Worker

基于 Cloudflare Workers 构建的高性能 VLESS 代理实现，具有优化的连接处理、多重回退策略和直观的 Web 管理界面。

## 🚀 主要特性

- **高性能 VLESS 协议**：高效的 VLESS 协议实现，优化的数据传输
- **多重连接策略**：
  - 直连
  - NAT64 支持（IPv4 到 IPv6 转换）
  - 代理 IP 回退
- **智能连接池**：快速连接建立，智能回退机制
- **批量处理**：优化的数据传输，支持批处理和并行处理
- **Web 管理界面**：用户友好的 Web 界面，用于配置和订阅管理
- **DNS 缓存**：内置 DNS 缓存减少延迟
- **实时数据流**：WebSocket 和 TCP 连接间的高效双向数据传输

## 📋 环境要求

- Cloudflare Workers 账户
- 自定义域名（可选但推荐）
- 对 VLESS 协议的基本了解

## 🛠️ 安装部署

### 1. 部署到 Cloudflare Workers

1. **创建新的 Worker**：
   - 前往 [Cloudflare 控制台](https://dash.cloudflare.com/)
   - 导航到 Workers & Pages
   - 点击"创建应用程序" → "创建 Worker"

2. **部署代码**：
   - 复制完整的脚本代码
   - 粘贴到 Worker 编辑器中
   - 点击"保存并部署"

### 2. 配置环境变量

在 Worker 设置中配置以下环境变量：

| 变量名 | 说明 | 默认值 | 必需 |
|--------|------|--------|------|
| `USER_ID` | 访问服务的唯一用户标识符 | `123456` | 否 |
| `UUID` | VLESS 认证用的 UUID | `aaa6b096-1165-4bbe-935c-99f4ec902d02` | 否 |
| `NODE_NAME` | VLESS 节点的显示名称 | `IKUN-Vless` | 否 |
| `BEST_IPS` | 换行分隔的最优 IP 地址列表 | 见默认值 | 否 |
| `PROXY_IP` | 回退代理 IP 和端口 | `sjc.o00o.ooo:443` | 否 |
| `ENABLE_NAT64` | 启用 NAT64 IPv4-to-IPv6 转换 | `false` | 否 |

### 3. 自定义域名（可选）

为了获得更好的性能和可靠性：
1. 将您的域名添加到 Cloudflare
2. 前往 Workers & Pages → 您的 Worker → 设置 → 触发器
3. 添加自定义域名路由

## 🔧 详细配置

### 环境变量详解

#### USER_ID
访问管理界面的唯一标识符。请更改为安全的随机值。

```bash
USER_ID=你的安全用户ID
```

#### UUID
用于客户端认证的 VLESS UUID。为了安全起见，请生成新的 UUID：

```bash
UUID=xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
```

#### BEST_IPS
逗号或换行分隔的最优 IP 地址列表：

```bash
BEST_IPS=developers.cloudflare.com
ip.sb
www.visa.cn
your-custom-ip.com
```

#### PROXY_IP
格式为 `主机:端口` 的回退代理服务器：

```bash
PROXY_IP=proxy.example.com:443
```

#### ENABLE_NAT64
启用 IPv4-to-IPv6 转换以获得更好的连接性：

```bash
ENABLE_NAT64=true
```

## 🌐 使用方法

### Web 管理界面

访问管理界面：
```
https://your-worker-domain.com/YOUR_USER_ID
```

界面提供：
- 节点配置概览
- 订阅链接
- 单个节点链接
- 一键复制功能

### 订阅链接

获取订阅配置：
```
https://your-worker-domain.com/YOUR_USER_ID/vless
```

### 客户端配置

在兼容的客户端中使用生成的 VLESS 链接：
- V2Ray
- Xray
- Clash
- 其他支持 VLESS 的客户端

## 🔒 安全注意事项

### 重要安全提醒

1. **更改默认值**：部署前务必更改默认的 `USER_ID` 和 `UUID`
2. **UUID 安全性**：使用加密安全的 UUID 生成器
3. **访问控制**：保持 `USER_ID` 私密 - 它是您的访问密钥
4. **域名安全**：使用带有适当 DNS 配置的自定义域名
5. **定期更新**：定期监控和更新 Worker

### 推荐安全实践

```bash
# 生成安全的 UUID（Linux/Mac）
uuidgen

# 生成随机 USER_ID
openssl rand -hex 16
```

## 📊 性能特性

### 连接优化
- **快速连接**：多重连接尝试，3秒超时
- **连接池**：高效的连接复用和管理
- **并行处理**：同时进行双向数据传输

### 数据传输优化
- **批量处理**：将多个小请求分组进行高效处理
- **流式传输**：实时数据流，无缓冲延迟
- **内存效率**：大数据传输的优化内存使用

## 🌍 网络特性

### IPv6 支持
- **NAT64**：启用时自动进行 IPv4-to-IPv6 转换
- **双栈支持**：同时支持 IPv4 和 IPv6 地址
- **智能路由**：基于网络条件的智能路由

### 回退机制
1. **直连**：主要连接方式
2. **NAT64 转换**：通过 IPv6 网络访问 IPv4 目标
3. **代理回退**：使用配置的代理 IP 作为最后手段

## 🛠️ API 参考

### 配置类
```javascript
const config = new Config(env, url);
```

### 连接函数
```javascript
const socket = await fastConnect(hostname, port, config);
```

### 协议解析器
```javascript
const vlessData = parseVlessHeader(buffer);
```

## 🐛 故障排除

### 常见问题

1. **连接失败**
   - 检查 `PROXY_IP` 是否可访问
   - 验证 `BEST_IPS` 配置
   - 在纯 IPv6 网络中启用 `NAT64`

2. **认证错误**
   - 验证 `UUID` 与客户端配置匹配
   - 检查访问 URL 中的 `USER_ID`

3. **性能问题**
   - 监控 Cloudflare Workers 使用限制
   - 考虑使用自定义域名获得更好的路由
   - 检查 DNS 缓存性能

### 调试步骤

1. **检查 Worker 日志**：
   - 前往 Cloudflare 控制台 → Workers → 您的 Worker → 日志
   - 监控实时日志中的错误

2. **测试连接**：
   ```bash
   curl -H "Upgrade: websocket" https://your-domain.com
   ```

3. **验证配置**：
   - 访问管理界面
   - 检查所有显示的配置

## 📈 监控

### 关键监控指标
- 连接成功率
- 数据传输性能
- 错误率和类型
- DNS 解析时间

### Cloudflare 分析
- Worker 调用次数
- 持续时间和 CPU 时间
- 错误率
- 地理分布

## ⚡ 性能优化技巧

1. **优化最佳 IP**：测试并配置您所在地区最快的 IP
2. **使用自定义域名**：通过自定义域名获得更好的路由和缓存
3. **启用 NAT64**：提高 IPv6 网络兼容性
4. **监控使用情况**：保持在 Cloudflare Workers 限制范围内

## 🔄 更新和维护

### 定期维护任务
- 基于性能测试更新 `BEST_IPS`
- 监控连接成功率
- 定期审查和轮换 `UUID`
- 检查代码更新和安全补丁

### 备份配置
进行更改前务必备份环境变量：

```bash
USER_ID=你的用户ID
UUID=你的UUID
NODE_NAME=你的节点名称
BEST_IPS=你的最佳IP列表
PROXY_IP=你的代理IP
ENABLE_NAT64=true/false
```

## 📚 技术架构

### 核心组件
- **配置管理器**：统一的配置管理和验证
- **连接管理器**：智能连接建立和管理
- **协议处理器**：高效的 VLESS 协议解析
- **数据传输器**：优化的双向数据流传输

### 数据流程
1. 客户端通过 WebSocket 连接到 Worker
2. Worker 解析 VLESS 协议头
3. 建立到目标服务器的连接
4. 建立双向数据隧道
5. 实时转发数据包

## 🎯 最佳实践

### 部署建议
1. 使用随机生成的强 UUID
2. 设置复杂的 USER_ID
3. 配置多个备用 IP 地址
4. 启用适当的网络特性（如 NAT64）
5. 使用自定义域名

### 安全建议
1. 定期更换 UUID
2. 监控访问日志
3. 限制 USER_ID 的分享
4. 使用 HTTPS 强制加密
5. 定期备份配置

## 📝 许可证

本项目仅供教育和个人使用。请遵守当地法律法规。

## ⚠️ 免责声明

此工具按"原样"提供，仅用于教育目的。用户需要负责：
- 遵守当地法律法规
- 正确的安全配置
- 监控和维护其部署
- 理解代理使用的影响

## 🤝 贡献

欢迎贡献！请确保：
- 代码遵循现有模式
- 维护安全最佳实践
- 保持性能优化
- 相应更新文档

## 📞 技术支持

如有问题：
1. 查看故障排除部分
2. 查阅 Cloudflare Workers 官方文档
3. 监控 Worker 日志获取具体错误信息

---

**注意**：此实现专为 Cloudflare Workers 环境优化，在其他平台使用可能需要修改。
