# VLESS Cloudflare Worker

一个基于 Cloudflare Worker 的 VLESS 代理服务，支持 WebSocket 传输、SOCKS5 代理回退、DNS over HTTPS 等功能。

## ✨ 特性

- 🚀 基于 Cloudflare Worker，无需服务器
- 🔐 支持 VLESS 协议与 UUID 验证
- 🌐 WebSocket 传输，支持 TLS 加密
- 🔄 多重连接回退策略（直连 → SOCKS5 → ProxyIP）
- 📡 DNS over HTTPS (DoH) 支持
- 🎯 灵活的节点配置与订阅生成
- 🛡️ 支持全局 SOCKS5 代理模式

## 🚀 快速开始

### 1. 部署到 Cloudflare Workers

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 进入 `Workers & Pages` → `Create application` → `Create Worker`
3. 将本项目代码粘贴到编辑器中
4. 点击 `Save and Deploy`

### 2. 配置环境变量

在 Worker 设置页面的 `Variables` 中添加以下环境变量：

| 变量名 | 必需 | 默认值 | 说明 |
|--------|------|--------|------|
| `USERID` | ❌ | `ikun` | 订阅路径的用户 ID |
| `UUID` | ❌ | `4ba0eec8-25e1-4ab3-b188-fd8a70b53984` | VLESS 用户 UUID |
| `NODE_NAME` | ❌ | `IKUN-vless` | 节点名称 |
| `URL` | ❌ | `example.com` | 非 WebSocket 请求的回退地址 |
| `BESTIPS` | ❌ | 见下方 | 优选 IP 列表 |
| `PROXYIP` | ❌ | - | 代理 IP，格式：`host:port` |
| `SOCKS5` | ❌ | - | SOCKS5 代理配置 |
| `GSOCKS5` | ❌ | `false` | 全局 SOCKS5 开关 |

#### 默认 BESTIPS 列表
```
ip.sb
www.visa.com
developers.cloudflare.com
ikun.glimmer.cf.090227.xyz
```

## 📋 使用方法

### 获取订阅链接

访问以下 URL 获取节点订阅：

```
https://your-worker-domain.workers.dev/YOUR_USERID
```

返回格式为纯文本，每行一个 `vless://` 链接。

### SOCKS5 配置格式

支持多种 SOCKS5 配置格式：

```bash
# 基本格式
user:pass@host:port

# 带协议前缀
socks5://user:pass@host:port
socks://user:pass@host:port

# Base64 用户名
socks://dXNlcjpwYXNzd29yZA==@host:port

# 全局 SOCKS5 格式
gsocks5://user:pass@host:port
gs5://user:pass@host:port
```

### URL 参数

支持通过 URL 参数动态配置：

| 参数 | 说明 | 示例 |
|------|------|------|
| `proxyip` | 临时代理 IP | `?proxyip=1.1.1.1:443` |
| `s5` / `socks5` | SOCKS5 代理 | `?s5=user:pass@host:1080` |
| `gs5` / `gsocks5` | 全局 SOCKS5 | `?gs5=user:pass@host:1080` |

### 连接策略

#### 普通模式（默认）
1. **直连** - 直接连接目标地址
2. **SOCKS5 回退** - 直连失败时使用 SOCKS5
3. **ProxyIP 回退** - SOCKS5 失败时使用代理 IP

#### 全局 SOCKS5 模式
1. **SOCKS5 优先** - 首先尝试 SOCKS5 连接
2. **自动降级** - 失败时自动切换到普通模式

## ⚙️ 高级配置

### 启用全局 SOCKS5

可以通过多种方式启用全局 SOCKS5：

1. **环境变量**：`GSOCKS5=true`
2. **URL 参数**：`?gs5=true` 或 `?gsocks5=true`
3. **路径参数**：`/gs5=socks5://user:pass@host:1080`

### 多种参数传递方式

```bash
# Query 参数
https://worker.dev/userid?s5=user:pass@host:1080

# Path 参数
https://worker.dev/userid/s5=user:pass@host:1080

# 全局模式
https://worker.dev/userid?gs5=user:pass@host:1080
```

### DNS over HTTPS

脚本自动处理 DNS 查询（UDP 端口 53），通过 Cloudflare DoH 服务解析：
- DoH 服务器：`https://1.1.1.1/dns-query`
- 自动转换 UDP DNS 为 HTTPS 请求

## 🛠️ 客户端配置

### V2Ray/V2RayN 配置示例

```json
{
  "protocol": "vless",
  "settings": {
    "vnext": [{
      "address": "your-bestip-or-domain",
      "port": 443,
      "users": [{
        "id": "your-uuid",
        "encryption": "none"
      }]
    }]
  },
  "streamSettings": {
    "network": "ws",
    "security": "tls",
    "wsSettings": {
      "path": "/?proxyip=1.1.1.1:443&s5=user:pass@host:1080",
      "headers": {
        "Host": "your-worker-domain.workers.dev"
      }
    },
    "tlsSettings": {
      "serverName": "your-worker-domain.workers.dev",
      "allowInsecure": true
    }
  }
}
```

### Clash Meta 配置示例

```yaml
proxies:
  - name: "VLESS-Worker"
    type: vless
    server: your-bestip-or-domain
    port: 443
    uuid: your-uuid
    tls: true
    servername: your-worker-domain.workers.dev
    skip-cert-verify: true
    network: ws
    ws-opts:
      path: /?proxyip=1.1.1.1:443
      headers:
        Host: your-worker-domain.workers.dev
```

## 🔍 故障排除

### 常见问题

1. **连接失败**
   - 检查 UUID 是否正确
   - 确认 TLS 设置和 SNI
   - 验证 WebSocket 路径

2. **SOCKS5 不工作**
   - 检查 SOCKS5 服务器可达性
   - 验证用户名密码格式
   - 确认端口设置

3. **订阅链接无法访问**
   - 检查 USERID 环境变量
   - 确认 Worker 域名正确

### 调试技巧

- 使用浏览器开发者工具查看 WebSocket 连接
- 检查 Cloudflare Worker 日志
- 测试不同的 BESTIPS 地址

## 📄 许可证

本项目基于开源协议发布，请遵守相关法律法规。

## ⚠️ 免责声明

- 本工具仅供学习和研究使用
- 请遵守当地法律法规
- 作者不承担任何使用风险

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

**注意**：使用前请确保了解并遵守 Cloudflare Workers 的使用条款和限制。
